# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- master

pool:
  vmImage: ubuntu-latest

variables:
  azureSubscription: 'rpbs-subscription(b3889971-9b7e-4807-a89c-c6f2b3297113)'
  appName: 'library-front' # Replace with your Azure Web App name
  resourceGroupName: 'library-project-rg' # Replace with your resource group
  nodeVersion: '16.x' # Match your React app's Node version

stages:
- stage: Build
  displayName: Build stage
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: $(nodeVersion)
      displayName: 'Install Node.js'
    
    - script: |
        npm install
        npm run build
      displayName: 'npm install and build'
    
    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: 'build'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/build.zip'
        replaceExistingArchive: true
      displayName: 'Archive build files'
    
    - publish: '$(Build.ArtifactStagingDirectory)/build.zip'
      artifact: drop
      displayName: 'Publish build artifact'

- stage: Deploy
  displayName: Deploy stage
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: Deploy
    displayName: Deploy
    environment: 'production'
    pool:
      vmImage: 'ubuntu-latest'
    
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop
            displayName: 'Download build artifact'
          
          - task: AzureWebApp@1
            displayName: 'Deploy to Azure Web App'
            inputs:
              azureSubscription: $(azureSubscription)
              appType: 'webAppLinux'
              appName: $(appName)
              resourceGroupName: $(resourceGroupName)
              package: '$(Pipeline.Workspace)/drop/build.zip'
              runtimeStack: 'NODE|16-lts'
              startupCommand: 'pm2 serve /home/site/wwwroot --no-daemon --spa'